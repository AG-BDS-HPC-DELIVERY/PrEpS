#!/usr/bin/env bash

# ------------------------------------------------------------------------------
## @file
## @author Nicolas Tallet <nicolas.2.tallet@eviden.com>
## @par URL https://github.com/AG-BDS-HPC-DELIVERY/PrEpS
## @par Purpose
## Comprehensive and Extensive Framework for Prolog/Epilog in Slurm
## @defgroup cpufreq CPU Frequency Management
## @defgroup cpupower API for cpupower Utility
## @defgroup fs Shared and Local Filesystems Management
## @defgroup kernel Linux Kernel Management
## @defgroup memory System Memory Management
## @defgroup nvidia NVIDIA GPU Subsystem Management
## @defgroup nvsmi API for NVIDIA SMI Utility
## @defgroup os Operating System Management
## @defgroup slurm Slurm Workload Scheduler Management
## @defgroup systemd systemd Units Management
## @defgroup thp Transparent Huge Pages (THP) Management
## @defgroup tuned tuned Profile Management
# ------------------------------------------------------------------------------

# ==============================================================================
# Function: main::help
# ==============================================================================
main::help() {
  cat <<- eof >&1

Prolog/Epilog for Slurm (PrEpS)

Usage: $(realpath "${BASH_SOURCE[0]}")

GitHub Repository: https://github.com/AG-BDS-HPC-DELIVERY/PrEpS/

eof
  exit 0
}

# ==============================================================================
# Function: main::log_event
# ==============================================================================
declare -A LOG_LEVELS=([TRACE]=0 [DEBUG]=1 [INFO]=2 [WARN]=3 [ERROR]=4 [FATAL]=5)
main::log_event() {
  declare -A log_levels=([TRACE]=0 [DEBUG]=1 [INFO]=2 [WARN]=3 [ERROR]=4 [FATAL]=5)
  local rc
  local -i singleton=0
  while (( $# > 0 )); do
    case "${1}" in
      -level)
        local level="${2}"
        shift
        ;;
      -message)
        local message="${2}"
        shift
        ;;
      -rc)
        local rc="${2}"
        shift
        ;;
      -singleton)
        singleton=1
        ;;
    esac
    shift
  done
  (( ${log_levels[${level}]} < ${log_levels[${PREPS_LOG_LEVEL}]} )) && (( ${log_levels[${level}]} < 4 )) && return 0
  (( "${singleton}" == 1 )) && [[ "${PREPS_NODENAME}" != "$(hostname --short)" ]] && return 0
  [[ "${level}" == "FATAL" ]] && message="${message:-Undefined Exception} @ ${FUNCNAME[1]}:${BASH_LINENO[0]}"
  flock --exclusive --timeout 2.5 "${PREPS_LOGFILE}" \
    printf "%26s | %8s | %-15s | %-15s | %-20s | %-5s | %s\n" \
      "$(date "+%Y-%m-%d %H:%M:%S %:z")" \
      "${SLURM_JOB_ID}" \
      "${SLURM_JOB_USER}" \
      "$(hostname --short)" \
      "${SLURM_SCRIPT_CONTEXT}" \
      "${level}" \
      "${message}${rc:+" (${rc})"}" >>"${PREPS_LOGFILE}"
  return 0
}
export -f "main::log_event"

# ==============================================================================
# Main Program: Prolog
# ==============================================================================
# Execution Time
time1=$(date +"%s%3N")

# Execution Arguments
while (( $# > 0 )); do
  case "${1}" in
    --help|-h)
      main::help
      ;;
    *)
      break
      ;;
  esac
  shift
done

# Overrides #1
if [[ -n "${SLURM_JOB_COMMENT}" ]]; then
  declare -A parameters
  IFS=";" read -a pairs -r <<<"${SLURM_JOB_COMMENT}"
  for pair in "${pairs[@]}"; do
    IFS="=" read -r key value <<<"${pair}"
    case "${key}" in
      "PREPS_LOG_LEVEL")
        PREPS_LOG_LEVEL="${value^^}"
        ;;
      "PREPS_PREFIX")
        PREPS_PREFIX="${value}"
        ;;
      *)
        parameters["${key}"]="${value}"
        ;;
    esac
  done
fi

# Environment
PREPS_EXECBIN="$(realpath "${BASH_SOURCE[0]}")"
PREPS_PREFIX="${PREPS_PREFIX:-$(realpath "$(dirname "${PREPS_EXECBIN}")/..")}"
PREPS_EXECBINDIR="${PREPS_PREFIX}/bin"
PREPS_BASENAME="$(basename "${PREPS_EXECBIN}")"
PREPS_NODENAME="${SLURMD_NODENAME:-$(hostname --short)}"
PREPS_CONFIGDIR="${PREPS_PREFIX}/etc"
PREPS_CONFIGFILE="${PREPS_CONFIGDIR}/config.sh"
PREPS_LIBEXECDIR="${PREPS_PREFIX}/libexec"
PREPS_LOGDIR="${PREPS_PREFIX}/var/log"
PREPS_LOGFILE="${PREPS_LOGDIR}/${PREPS_BASENAME}.$(date +"%d").log"
PREPS_RUNDIR="${PREPS_PREFIX}/run"
export PREPS_LOG_LEVEL PREPS_LOGFILE PREPS_NODENAME PREPS_RUNDIR
export PATH="/usr/sbin:${PATH}"
source "${PREPS_CONFIGFILE}" &> /dev/null ||
  { main::log_event -level "ERROR" -message "Failed to Load PrEpS Configuration from File: [${PREPS_CONFIGFILE}] - Skipping Prolog/Epilog" -singleton; exit 0; }
PREPS_LOG_LEVEL="${PREPS_LOG_LEVEL:-PREPS_LOG_LEVEL_DEFAULT}"

# Modules
while IFS= read -d '' -r -u 9 modulefile; do
  module="$(awk 'match($0, /^([_a-z]+::[_a-z]+::[_a-z]+)\(\)/, a) {print a[1]}' "${modulefile}")"
  # shellcheck source=/dev/null
  source "${modulefile}" &> /dev/null || main::log_event -level "WARN" -message "Failed to Load Modulefile: [${modulefile}]" -singleton
  if [[ -n "${module}" ]] && [[ "$(type -t "${module}" 2>/dev/null)" == "function" ]]; then
    # shellcheck disable=SC2163
    export -f "${module}" || main::log_event -level "WARN" -message "Failed to Export Module: [${module}]" -singleton
  fi
done 9< <(find "${PREPS_LIBEXECDIR}"/ -name "*.sh" -print0)

# Message
main::log_event -level "TRACE" -message "Starting PrEpS"

# ==============================================================================
# Main Program: Body
# ==============================================================================
# Root User
[[ -n "${SLURM_JOB_USER}" ]] &&
  main::log_event -level "DEBUG" -message "Performing Execution under User Account: [$(id --name --user)] on Behalf of User Account: [${SLURM_JOB_USER}]" -singleton
(( EUID != 0 )) && export SUDO="sudo"

# Overrides #2
[[ -d "${PREPS_PREFIX}" ]] || main::log_event -level "FATAL" -message "Invalid Prefix: [${PREPS_PREFIX}]" -singleton
[[ ${LOG_LEVELS["${PREPS_LOG_LEVEL}"]} ]] || main::log_event -level "FATAL" -message "Invalid Log Level: [${PREPS_LOG_LEVEL}]" -singleton
if [[ -n "${SLURM_JOB_COMMENT}" ]]; then
  for key in "${!parameters[@]}"; do
    printf -v "${key}" "%s" "${parameters["${key}"]}"
    # shellcheck disable=SC2163
    export "${key}" &&
      main::log_event -level "DEBUG" -message "Registered Override: [${key}] -> Value: [${parameters["${key}"]}]" -singleton
  done
fi

# Slurm Script Execution
rc=0
if [[ "${PREPS_SKIP_PROLOG_SLURMD,,}" =~ ^y([e][s])*$ && "${SLURM_SCRIPT_CONTEXT,,}" == "prolog_slurmd" ]]; then
  main::log_event -level "INFO" -message "Skipping Slurm Prolog per User Request" -singleton
else
  execbin="${PREPS_EXECBINDIR}/${PREPS_BASENAME}.${SLURM_SCRIPT_CONTEXT,,}"
  [[ -x "${execbin}.${SLURM_JOB_PARTITION}" ]] && execbin="${execbin}.${SLURM_JOB_PARTITION}"
  main::log_event -level "TRACE" -message "Executing Script: [${execbin}]"
  "${execbin}"
  rc=$?
fi

# ==============================================================================
# Main Program: Epilog
# ==============================================================================
# Execution Time
time2=$(date +"%s%3N")
exectime=$(( time2 - time1 ))
main::log_event -level "INFO" -message "PrEpS Execution Time (ms): [${exectime}]"

# Message
main::log_event -level "TRACE" -message "Stopping PrEpS" -rc "${?}"

# Error Mode
[[ "${PREPS_EXECUTION_MODE,,}" == "strict" ]] || rc=0

exit ${rc}
